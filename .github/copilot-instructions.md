# GitHub Copilot Instructions

This is **Cupcake** — a lightweight, single-page task management app built with Node.js, Express, and TypeScript. The browser bundle (`public/app.js`) is compiled from `public/app.ts` via `tsc`.

## Project Layout

```
cupcake/
├── server.ts          # Express server + REST API (port 3000 by default)
├── db.ts              # SQLite data-access layer
├── package.json       # npm scripts and dependencies
├── tsconfig.json      # TypeScript config for server + tests
├── tsconfig.client.json  # TypeScript config for browser bundle
├── public/
│   ├── index.html     # Single-page UI
│   ├── style.css      # Styles
│   ├── app.ts         # Browser-side fetch logic (TypeScript source)
│   └── app.js         # Compiled browser bundle (generated by tsc)
├── tests/
│   ├── server.test.ts # Backend API tests (Jest + supertest)
│   ├── db.test.ts     # Data-access layer unit tests
│   └── app.test.ts    # Frontend DOM tests (Jest + jsdom)
├── configure.sh       # One-time setup (npm install)
├── build.sh           # Type-check + compile browser bundle + audit
├── run_local.sh       # Run the app locally (npm run dev)
├── test.sh            # Run the test suite (npm test)
├── clean.sh           # Remove generated artefacts (node_modules)
├── DESIGN.md          # Architecture and technology decisions
└── AGENTS.md          # Guidance for AI coding agents
```

## Development Workflow

| Task | Command |
|------|---------|
| First-time setup | `bash configure.sh` |
| Build              | `bash build.sh` |
| Start dev server  | `bash run_local.sh` |
| Run tests         | `bash test.sh` |
| Clean artefacts   | `bash clean.sh` |

## Code Conventions

- Use TypeScript strict mode (`"strict": true` in tsconfig). All source files are `.ts`.
- Use `crypto.randomUUID()` for generating unique IDs (never `Math.random()`).
- Respect the `PORT` environment variable with `process.env.PORT || 3000`.
- Use `textContent` (not `innerHTML`) when inserting user-supplied text to prevent XSS.
- The server exports `app` via `export = app` and starts listening only when run directly (`require.main === module`). This makes the server testable via supertest without starting a real HTTP listener.
- **The build must be warning-free.** `bash build.sh` runs TypeScript type-checking and `npm audit --audit-level=high`, exiting non-zero on any failure. Treat every type error or audit finding as a build error that must be resolved before merging.

## Testing

Tests live in `tests/`. Run them with `bash test.sh` or `npm test`.

- **Backend tests** (`tests/server.test.ts`): use Jest + supertest. Each `beforeEach` resets modules so every test gets a fresh in-memory task store.
- **DB tests** (`tests/db.test.ts`): direct unit tests for the data-access layer.
- **Frontend tests** (`tests/app.test.ts`): use Jest with the jsdom environment. They set up the DOM fixture, mock `global.fetch`, then `require('../public/app.ts')` to exercise the browser code.

When adding new features:
1. Add or update the relevant test in `tests/`.
2. Make sure `npm test` passes before pushing.

## API Summary

| Method | Path | Description |
|--------|------|-------------|
| GET    | `/api/tasks`      | List all tasks |
| POST   | `/api/tasks`      | Create a task (`{ title }`) |
| PUT    | `/api/tasks/:id`  | Update a task (`{ title?, done? }`) |
| DELETE | `/api/tasks/:id`  | Delete a task |

Tasks have the shape `{ id, title, done, createdAt }`.
